import os
import json
import base64
import time
from openai import OpenAI

def build_concise_prompt_l(context, sticker_text, similar_intent_rules=""): #需要补充细粒度特征标签表和相近意图判定规则表
    """严格按照指定格式构建提示词"""
    # 处理上下文格式（将制表符转换为更易读的格式）
    if context and context.strip():
        context_display = "，".join([line.strip() for line in context.split('\t') if line.strip()])
    else:
        context_display = "无"

    # 处理表情包文本
    sticker_text_display = sticker_text if sticker_text and sticker_text.strip() else "无"

    # 处理相近意图判定规则表
    similar_intent_display = similar_intent_rules if similar_intent_rules and similar_intent_rules.strip() else "暂无"

    # 严格按照指定格式构建提示词
    prompt = f"""
角色与任务设定  
• 核心角色：你是一个人类情感倾向和意图识别专家，你正在和用户聊天，根据用户的上下文和表情包理解用户的意图和情感倾向。  

• 输出要求：必须从给定标签列表中选择一组意图-情感倾向标签。  
	
输入信息定义  
• 上下文：[社交媒体聊天发言]  

• 表情包：[表情包图像]  

• 表情包内文本：[表情包内的文字，也可能没有]  

预定义标签列表：你务必从预定标签列表中选择最合适的标签输出
意图标签：[
0: 抱怨，

1: 表扬

2: 同意

3: 妥协

4: 询问 

5: 开玩笑，说着玩

6: 反对

7: 告知，通知

8: 求助

9: 问候

10: 嘲讽

11: 介绍

12: 猜测，估计

13: 离开

14: 建议

15: 炫耀

16: 批评

17: 道谢

18: 安慰

19: 道歉
]
情感倾向标签：[
0: 无明显情绪（Neutral）

1: 积极（Positive）

2: 消极（Negative）
] 

**规则初始化**：
首先明确代理意图属于开集合，不止是给的预定标签，且可为空。细粒度特征包含5个维度：前3个维度（形象、表情、动作）针对图像模态，后2个维度（文本副词、文本修辞）针对文本模态。

**严格按照以下思维链推理**：  
让我们一步一步思考
第一步，分析表情包
首先思考表情包表达的情感倾向和代理意图，你需要根据表情包文本和图像来推理表情包表达的意图和情感倾向。考虑表情包图像的形象、表情、动作所蕴含的情感倾向和代理意图；按照词为单位，考虑文本助词（如”这”、”耶”、”只能”）和修辞手法分析表情包文本代理意图和情感倾向。
冲突检测：如果图像和文本的情感倾向相悖（如图像积极但文本消极，且相悖情况只存在于积极和消极之间），则考虑是用表情包来反讽（negative），还是用表情包突出某种崇拜（positive）。如果图像和文本均无明显意图或情感，则忽略表情包（Neutral，无代理意图）。在此情况下可以不用再考虑表情包；

第二步，结合上下文分析，明确意图往往来自于上下文：
务必逐词且逐句地分析上下文，分析上下文表达的所有可能的代理意图，并确定上下文表达的情感倾向。请忽略你遇到的不确定的梗。
根据上下文分析事件原貌和情景，务必明确用户的上下文是指向用户，还是你，还是其他人，尤其出现“你”、“他”，思考情景是怎样的，比如在向你推荐东西还是正常的朋友交流等。
冲突检测：结合表情包分析得出的代理意图，注意当表情包的情感倾向与上下文的情感倾向完全相反时，则考虑是用表情包来反讽（negative），还是用表情包突出某种崇拜（positive）。以此确定用户的情感倾向。

第三步：根据确定的情感倾向和获取的代理意图集合重新解释事件：
根据确定后的情感倾向筛选从表情包和上下文获得的代理意图，删除与情感相悖的代理意图（如代理意图“表扬”显然与情感消极相悖，则删去“赞扬”）
根据情感倾向以及筛选后的优先以上下文得出的代理意图集合进一步修正和细化事件原貌，根据事件补充之前没考虑到的代理意图。
务必明确用户可能表达不止一种意图，并优先考虑上下文，只在明显的反讽和情感相悖（积极和消极）时才优先考虑表情包，例如：用户上下文是谢谢，但表情包的情感倾向是消极，那么将事件修正为你可能是好心办坏事了，让用户嘴上说着谢谢，但心里并不高兴。

第四步：最后根据事件筛选并确定符合事件的代理意图，将剩余的代理意图因子集合映射到预定义意图标签列表，获得候选意图集合。根据修正后的**事件原貌和情景**思考得出用户最主要的意图，务必分清事件的主次意图：
首先根据修正后的事件从预选标签中给出用户表达的所有意图标签，例如：从上下文“这是我朋友John，他足球踢的特别好”得出事件-用户在介绍他的一个擅长踢足球的朋友-标签“介绍”和“表扬”；
接下来将之前筛选得到的代理意图也考虑进来，思考他们更偏向于映射到哪个意图标签，优先考虑来自上下文的代理意图，因为用户的意图一般集中在上下文。例如上面的例子有“介绍”和“表扬”意图，优先以动作类意图（如“介绍”）为主，情感表达类意图（如“表扬”）为辅，除非用户只是单纯的抒发情感；
最后很可能碰到意思相近的意图判断，务必思考用户表达出的哪些代理意图可以作为意图标签的依据。当你遇到主次意图或相近意图难以区分时，请参考以下判别指南：
{similar_intent_display}

输出格式（严格服从输出格式，输出不需要中括号）  
 
意图：[序号 + 名称，如：1夸奖]  
情感：[序号 + 名称，如：2Positive]   
推理链：[
特征提取：简述识别到的关键细粒度特征和其蕴含的代理意图或情感。
事件还原：描述当时聊天的情景。
冲突处理：如果存在表情包图像与配文或表情包和上下文的情感倾向冲突，说明判定的理由。
意图定夺：如果存在多个候选意图（如A和B），请给出选择该意图作为主要的理由。
]

任务输入：
• 上下文：{context_display}
• 表情包：见上传的图像
• 表情包内文本：{sticker_text_display}"""

    return prompt